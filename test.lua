ablocks = {}

ablocks[1] = {type = 6, lane = 1, chainstart = 0.69655311107635, seconds = 0.69655311107635, chainend = 0.90551906824112}
ablocks[2] = {type = 6, lane = -1, chainstart = 1.0448296070099, seconds = 1.0448296070099, chainend = 1.0448296070099}
ablocks[3] = {type = 6, lane = 0, chainstart = 1.2537956237793, seconds = 1.2537956237793, chainend = 1.3931062221527}
ablocks[4] = {type = 6, lane = 1, chainstart = 1.6020721197128, seconds = 1.6020721197128, chainend = 1.8110381364822}
ablocks[5] = {type = 6, lane = -1, chainstart = 2.0432224273682, seconds = 2.0432224273682, chainend = 2.321843624115}
ablocks[6] = {type = 6, lane = 0, chainstart = 2.5308096408844, seconds = 2.5308096408844, chainend = 2.5308096408844}
ablocks[7] = {type = 6, lane = -1, chainstart = 2.646901845932, seconds = 2.646901845932, chainend = 2.7397756576538}
ablocks[8] = {type = 6, lane = 1, chainstart = 2.8558678627014, seconds = 2.8558678627014, chainend = 2.8558678627014}
ablocks[9] = {type = 6, lane = 0, chainstart = 2.9719598293304, seconds = 2.9719598293304, chainend = 3.0648336410522}
ablocks[10] = {type = 6, lane = 0, chainstart = 3.1809258460999, seconds = 3.1809258460999, chainend = 3.2273626327515}
ablocks[11] = {type = 6, lane = 1, chainstart = 3.4131102561951, seconds = 3.4131102561951, chainend = 3.4595470428467}
ablocks[12] = {type = 6, lane = 0, chainstart = 3.5988576412201, seconds = 3.5988576412201, chainend = 3.5988576412201}
ablocks[13] = {type = 6, lane = 0, chainstart = 3.8310420513153, seconds = 3.8310420513153, chainend = 3.9006974697113}
ablocks[14] = {type = 6, lane = 0, chainstart = 4.1096634864807, seconds = 4.1096634864807, chainend = 4.1096634864807}
ablocks[15] = {type = 6, lane = -1, chainstart = 4.3186292648315, seconds = 4.3186292648315, chainend = 4.3186292648315}
ablocks[16] = {type = 5, lane = 0, chainstart = 4.5275950431824, seconds = 4.5275950431824, chainend = 4.5275950431824}
ablocks[17] = {type = 5, lane = 0, chainstart = 4.5508136749268, seconds = 4.5508136749268, chainend = 4.5508136749268}
ablocks[18] = {type = 5, lane = 0, chainstart = 4.6204690933228, seconds = 4.6204690933228, chainend = 4.6204690933228}
ablocks[19] = {type = 5, lane = 0, chainstart = 4.6901240348816, seconds = 4.6901240348816, chainend = 4.6901240348816}
ablocks[20] = {type = 5, lane = 0, chainstart = 4.7365612983704, seconds = 4.7365612983704, chainend = 4.7365612983704}
ablocks[21] = {type = 5, lane = 0, chainstart = 4.8062162399292, seconds = 4.8062162399292, chainend = 4.8062162399292}
ablocks[22] = {type = 5, lane = 0, chainstart = 4.8758716583252, seconds = 4.8758716583252, chainend = 4.8758716583252}
ablocks[23] = {type = 5, lane = 0, chainstart = 4.9455270767212, seconds = 4.9455270767212, chainend = 4.9455270767212}
ablocks[24] = {type = 5, lane = 0, chainstart = 5.0035729408264, seconds = 5.0035729408264, chainend = 5.0035729408264}
ablocks[25] = {type = 5, lane = 0, chainstart = 5.0616192817688, seconds = 5.0616192817688, chainend = 5.0616192817688}
ablocks[26] = {type = 5, lane = 0, chainstart = 5.1312747001648, seconds = 5.1312747001648, chainend = 5.1312747001648}
ablocks[27] = {type = 5, lane = 0, chainstart = 5.1777114868164, seconds = 5.1777114868164, chainend = 5.1777114868164}
ablocks[28] = {type = 5, lane = 0, chainstart = 5.2473669052124, seconds = 5.2473669052124, chainend = 5.2473669052124}
ablocks[29] = {type = 5, lane = 0, chainstart = 5.3170218467712, seconds = 5.3170218467712, chainend = 5.3170218467712}
ablocks[30] = {type = 5, lane = 0, chainstart = 5.36345911026, seconds = 5.36345911026, chainend = 5.36345911026}
ablocks[31] = {type = 6, lane = -1, chainstart = 5.4331140518188, seconds = 5.4331140518188, chainend = 5.4331140518188}
ablocks[32] = {type = 6, lane = 0, chainstart = 5.5259881019592, seconds = 5.5259881019592, chainend = 5.5259881019592}
ablocks[33] = {type = 6, lane = 0, chainstart = 5.5956435203552, seconds = 5.5956435203552, chainend = 5.6536893844604}
ablocks[34] = {type = 6, lane = 0, chainstart = 5.7349538803101, seconds = 5.7349538803101, chainend = 5.7813906669617}
ablocks[35] = {type = 5, lane = 0, chainstart = 6.1064491271973, seconds = 6.1064491271973, chainend = 6.1064491271973}
ablocks[36] = {type = 5, lane = 0, chainstart = 6.1528859138489, seconds = 6.1528859138489, chainend = 6.1528859138489}
ablocks[37] = {type = 6, lane = 0, chainstart = 6.4547252655029, seconds = 6.4547252655029, chainend = 6.5592083930969}
ablocks[38] = {type = 6, lane = 0, chainstart = 7.244152545929, seconds = 7.244152545929, chainend = 7.2673707008362}
ablocks[39] = {type = 6, lane = -1, chainstart = 7.3602447509766, seconds = 7.3602447509766, chainend = 7.5227737426758}
ablocks[40] = {type = 6, lane = -1, chainstart = 7.6736931800842, seconds = 7.6736931800842, chainend = 7.7317395210266}
ablocks[41] = {type = 6, lane = 1, chainstart = 8.5908212661743, seconds = 8.5908212661743, chainend = 8.6372585296631}
ablocks[42] = {type = 5, lane = 1, chainstart = 8.8230056762695, seconds = 8.8230056762695, chainend = 8.8230056762695}
ablocks[43] = {type = 6, lane = 1, chainstart = 9.4963407516479, seconds = 9.4963407516479, chainend = 9.5427780151367}
ablocks[44] = {type = 5, lane = -1, chainstart = 9.7749624252319, seconds = 9.7749624252319, chainend = 9.7749624252319}
ablocks[45] = {type = 6, lane = 0, chainstart = 10.401859283447, seconds = 10.401859283447, chainend = 10.448296546936}
ablocks[46] = {type = 5, lane = -1, chainstart = 10.657262802124, seconds = 10.657262802124, chainend = 10.657262802124}
ablocks[47] = {type = 5, lane = -1, chainstart = 10.84300994873, seconds = 10.84300994873, chainend = 10.84300994873}
ablocks[48] = {type = 6, lane = -1, chainstart = 11.260941505432, seconds = 11.260941505432, chainend = 11.35381603241}
ablocks[49] = {type = 5, lane = -1, chainstart = 11.539563179016, seconds = 11.539563179016, chainend = 11.539563179016}
ablocks[50] = {type = 6, lane = 0, chainstart = 12.166460990906, seconds = 12.166460990906, chainend = 12.259334564209}
ablocks[51] = {type = 5, lane = 1, chainstart = 12.421863555908, seconds = 12.421863555908, chainend = 12.421863555908}
ablocks[52] = {type = 6, lane = -1, chainstart = 13.118416786194, seconds = 13.118416786194, chainend = 13.164854049683}
ablocks[53] = {type = 5, lane = 1, chainstart = 13.791751861572, seconds = 13.791751861572, chainend = 13.791751861572}
ablocks[54] = {type = 6, lane = 0, chainstart = 14.000717163086, seconds = 14.000717163086, chainend = 14.047154426575}
ablocks[55] = {type = 5, lane = 1, chainstart = 14.232901573181, seconds = 14.232901573181, chainend = 14.232901573181}
ablocks[56] = {type = 6, lane = 1, chainstart = 14.674052238464, seconds = 14.674052238464, chainend = 14.720489501953}
ablocks[57] = {type = 6, lane = 0, chainstart = 14.894627571106, seconds = 14.894627571106, chainend = 14.952672958374}
ablocks[58] = {type = 6, lane = -1, chainstart = 15.161639213562, seconds = 15.161639213562, chainend = 15.184857368469}
ablocks[59] = {type = 6, lane = 1, chainstart = 15.579570770264, seconds = 15.579570770264, chainend = 15.626008033752}
ablocks[60] = {type = 6, lane = 0, chainstart = 15.788537025452, seconds = 15.788537025452, chainend = 15.858192443848}
ablocks[61] = {type = 6, lane = -1, chainstart = 16.067157745361, seconds = 16.067157745361, chainend = 16.067157745361}
ablocks[62] = {type = 6, lane = 0, chainstart = 16.485090255737, seconds = 16.485090255737, chainend = 16.554744720459}
ablocks[63] = {type = 6, lane = 0, chainstart = 16.694055557251, seconds = 16.694055557251, chainend = 16.740493774414}
ablocks[64] = {type = 6, lane = 1, chainstart = 16.949459075928, seconds = 16.949459075928, chainend = 16.995895385742}
ablocks[65] = {type = 5, lane = -1, chainstart = 17.158424377441, seconds = 17.158424377441, chainend = 17.158424377441}
ablocks[66] = {type = 5, lane = 0, chainstart = 17.390609741211, seconds = 17.390609741211, chainend = 17.390609741211}
ablocks[67] = {type = 5, lane = 0, chainstart = 17.437046051025, seconds = 17.437046051025, chainend = 17.437046051025}
ablocks[68] = {type = 6, lane = 0, chainstart = 17.599575042725, seconds = 17.599575042725, chainend = 17.669231414795}
ablocks[69] = {type = 6, lane = 1, chainstart = 17.831760406494, seconds = 17.831760406494, chainend = 17.901414871216}
ablocks[70] = {type = 6, lane = 1, chainstart = 18.307737350464, seconds = 18.307737350464, chainend = 18.342565536499}
ablocks[71] = {type = 6, lane = 1, chainstart = 18.481876373291, seconds = 18.481876373291, chainend = 18.528312683105}
ablocks[72] = {type = 6, lane = -1, chainstart = 18.760496139526, seconds = 18.760496139526, chainend = 18.818542480469}
ablocks[73] = {type = 6, lane = 1, chainstart = 18.992681503296, seconds = 18.992681503296, chainend = 18.992681503296}
ablocks[74] = {type = 6, lane = 1, chainstart = 19.085556030273, seconds = 19.085556030273, chainend = 19.085556030273}
ablocks[75] = {type = 6, lane = 0, chainstart = 19.20164680481, seconds = 19.20164680481, chainend = 19.27130317688}
ablocks[76] = {type = 6, lane = -1, chainstart = 19.399003982544, seconds = 19.399003982544, chainend = 19.526704788208}
ablocks[77] = {type = 6, lane = -1, chainstart = 19.596361160278, seconds = 19.596361160278, chainend = 19.712453842163}
ablocks[78] = {type = 5, lane = 1, chainstart = 19.874982833862, seconds = 19.874982833862, chainend = 19.874982833862}
ablocks[79] = {type = 5, lane = 1, chainstart = 19.886590957642, seconds = 19.886590957642, chainend = 19.886590957642}
ablocks[80] = {type = 5, lane = 1, chainstart = 19.944637298584, seconds = 19.944637298584, chainend = 19.944637298584}
ablocks[81] = {type = 5, lane = 1, chainstart = 20.014291763306, seconds = 20.014291763306, chainend = 20.014291763306}
ablocks[82] = {type = 5, lane = 1, chainstart = 20.083948135376, seconds = 20.083948135376, chainend = 20.083948135376}
ablocks[83] = {type = 5, lane = 1, chainstart = 20.141994476318, seconds = 20.141994476318, chainend = 20.141994476318}
ablocks[84] = {type = 5, lane = 1, chainstart = 20.153602600098, seconds = 20.153602600098, chainend = 20.153602600098}
ablocks[85] = {type = 5, lane = 1, chainstart = 20.316131591797, seconds = 20.316131591797, chainend = 20.316131591797}
ablocks[86] = {type = 6, lane = -1, chainstart = 20.548316955566, seconds = 20.548316955566, chainend = 20.664409637451}
ablocks[87] = {type = 6, lane = 1, chainstart = 20.803718566895, seconds = 20.803718566895, chainend = 20.803718566895}
ablocks[88] = {type = 6, lane = 0, chainstart = 20.919811248779, seconds = 20.919811248779, chainend = 21.105558395386}
ablocks[89] = {type = 6, lane = 1, chainstart = 21.221651077271, seconds = 21.221651077271, chainend = 21.291307449341}
ablocks[90] = {type = 6, lane = -1, chainstart = 21.45383644104, seconds = 21.45383644104, chainend = 21.546709060669}
ablocks[91] = {type = 5, lane = 1, chainstart = 21.662801742554, seconds = 21.662801742554, chainend = 21.662801742554}
ablocks[92] = {type = 5, lane = 1, chainstart = 21.732456207275, seconds = 21.732456207275, chainend = 21.732456207275}
ablocks[93] = {type = 5, lane = 1, chainstart = 21.778894424438, seconds = 21.778894424438, chainend = 21.778894424438}
ablocks[94] = {type = 5, lane = 1, chainstart = 21.836940765381, seconds = 21.836940765381, chainend = 21.836940765381}
ablocks[95] = {type = 5, lane = 1, chainstart = 21.894985198975, seconds = 21.894985198975, chainend = 21.894985198975}
ablocks[96] = {type = 5, lane = 1, chainstart = 21.941423416138, seconds = 21.941423416138, chainend = 21.941423416138}
ablocks[97] = {type = 5, lane = 1, chainstart = 21.987859725952, seconds = 21.987859725952, chainend = 21.987859725952}
ablocks[98] = {type = 5, lane = 1, chainstart = 22.057514190674, seconds = 22.057514190674, chainend = 22.057514190674}
ablocks[99] = {type = 5, lane = 1, chainstart = 22.103952407837, seconds = 22.103952407837, chainend = 22.103952407837}
ablocks[100] = {type = 5, lane = 1, chainstart = 22.150388717651, seconds = 22.150388717651, chainend = 22.150388717651}
ablocks[101] = {type = 6, lane = -1, chainstart = 22.382574081421, seconds = 22.382574081421, chainend = 22.47544670105}
ablocks[102] = {type = 5, lane = 0, chainstart = 22.591539382935, seconds = 22.591539382935, chainend = 22.591539382935}
ablocks[103] = {type = 5, lane = 1, chainstart = 22.707632064819, seconds = 22.707632064819, chainend = 22.707632064819}
ablocks[104] = {type = 6, lane = -1, chainstart = 22.800504684448, seconds = 22.800504684448, chainend = 22.916597366333}
ablocks[105] = {type = 6, lane = -1, chainstart = 23.009471893311, seconds = 23.009471893311, chainend = 23.125562667847}
ablocks[106] = {type = 6, lane = 0, chainstart = 23.241655349731, seconds = 23.241655349731, chainend = 23.357748031616}
ablocks[107] = {type = 6, lane = -1, chainstart = 23.48544883728, seconds = 23.48544883728, chainend = 23.56671333313}
ablocks[108] = {type = 6, lane = 0, chainstart = 23.659587860107, seconds = 23.659587860107, chainend = 23.845335006714}
ablocks[109] = {type = 6, lane = 0, chainstart = 23.914989471436, seconds = 23.914989471436, chainend = 23.961427688599}
ablocks[110] = {type = 6, lane = -1, chainstart = 24.147174835205, seconds = 24.147174835205, chainend = 24.26326751709}
ablocks[111] = {type = 5, lane = 1, chainstart = 24.402576446533, seconds = 24.402576446533, chainend = 24.402576446533}
ablocks[112] = {type = 6, lane = 1, chainstart = 24.611543655396, seconds = 24.611543655396, chainend = 24.73924446106}
ablocks[113] = {type = 6, lane = 0, chainstart = 24.820508956909, seconds = 24.820508956909, chainend = 24.936601638794}
ablocks[114] = {type = 6, lane = 1, chainstart = 25.052694320679, seconds = 25.052694320679, chainend = 25.1223487854}
ablocks[115] = {type = 6, lane = 1, chainstart = 25.192003250122, seconds = 25.192003250122, chainend = 25.192003250122}
ablocks[116] = {type = 5, lane = -1, chainstart = 25.2848777771, seconds = 25.2848777771, chainend = 25.2848777771}
ablocks[117] = {type = 5, lane = -1, chainstart = 25.296487808228, seconds = 25.296487808228, chainend = 25.296487808228}
ablocks[118] = {type = 5, lane = -1, chainstart = 25.308095932007, seconds = 25.308095932007, chainend = 25.308095932007}
ablocks[119] = {type = 6, lane = 0, chainstart = 25.517063140869, seconds = 25.517063140869, chainend = 25.633153915405}
ablocks[120] = {type = 6, lane = 0, chainstart = 25.702810287476, seconds = 25.702810287476, chainend = 25.726028442383}
ablocks[121] = {type = 6, lane = 1, chainstart = 25.958211898804, seconds = 25.958211898804, chainend = 26.074304580688}
ablocks[122] = {type = 5, lane = 1, chainstart = 26.190397262573, seconds = 26.190397262573, chainend = 26.190397262573}
ablocks[123] = {type = 6, lane = -1, chainstart = 26.306489944458, seconds = 26.306489944458, chainend = 26.306489944458}
ablocks[124] = {type = 5, lane = 0, chainstart = 26.399362564087, seconds = 26.399362564087, chainend = 26.399362564087}
ablocks[125] = {type = 5, lane = 0, chainstart = 26.434190750122, seconds = 26.434190750122, chainend = 26.434190750122}
ablocks[126] = {type = 5, lane = 0, chainstart = 26.492237091064, seconds = 26.492237091064, chainend = 26.492237091064}
ablocks[127] = {type = 5, lane = 0, chainstart = 26.538673400879, seconds = 26.538673400879, chainend = 26.538673400879}
ablocks[128] = {type = 5, lane = 0, chainstart = 26.608327865601, seconds = 26.608327865601, chainend = 26.608327865601}
ablocks[129] = {type = 5, lane = 0, chainstart = 26.654766082764, seconds = 26.654766082764, chainend = 26.654766082764}
ablocks[130] = {type = 6, lane = -1, chainstart = 26.863731384277, seconds = 26.863731384277, chainend = 26.991432189941}
ablocks[131] = {type = 6, lane = 0, chainstart = 27.084306716919, seconds = 27.084306716919, chainend = 27.119134902954}
ablocks[132] = {type = 6, lane = 0, chainstart = 27.304882049561, seconds = 27.304882049561, chainend = 27.444192886353}
ablocks[133] = {type = 6, lane = 1, chainstart = 27.548675537109, seconds = 27.548675537109, chainend = 27.653158187866}
ablocks[134] = {type = 6, lane = -1, chainstart = 27.78085899353, seconds = 27.78085899353, chainend = 27.896951675415}
ablocks[135] = {type = 6, lane = -1, chainstart = 27.954998016357, seconds = 27.954998016357, chainend = 28.001434326172}
ablocks[136] = {type = 6, lane = 1, chainstart = 28.210401535034, seconds = 28.210401535034, chainend = 28.32649230957}
ablocks[137] = {type = 6, lane = 0, chainstart = 28.442584991455, seconds = 28.442584991455, chainend = 28.55867767334}
ablocks[138] = {type = 6, lane = 0, chainstart = 28.674770355225, seconds = 28.674770355225, chainend = 28.767642974854}
ablocks[139] = {type = 6, lane = -1, chainstart = 28.883735656738, seconds = 28.883735656738, chainend = 28.95339012146}
ablocks[140] = {type = 5, lane = -1, chainstart = 29.115919113159, seconds = 29.115919113159, chainend = 29.115919113159}
ablocks[141] = {type = 5, lane = -1, chainstart = 29.162357330322, seconds = 29.162357330322, chainend = 29.162357330322}
ablocks[142] = {type = 5, lane = -1, chainstart = 29.232011795044, seconds = 29.232011795044, chainend = 29.232011795044}
ablocks[143] = {type = 5, lane = -1, chainstart = 29.278448104858, seconds = 29.278448104858, chainend = 29.278448104858}
ablocks[144] = {type = 5, lane = -1, chainstart = 29.348104476929, seconds = 29.348104476929, chainend = 29.348104476929}
ablocks[145] = {type = 5, lane = -1, chainstart = 29.371322631836, seconds = 29.371322631836, chainend = 29.371322631836}
ablocks[146] = {type = 6, lane = -1, chainstart = 29.557069778442, seconds = 29.557069778442, chainend = 29.719598770142}
ablocks[147] = {type = 6, lane = -1, chainstart = 29.789255142212, seconds = 29.789255142212, chainend = 29.812473297119}
ablocks[148] = {type = 5, lane = 0, chainstart = 29.928565979004, seconds = 29.928565979004, chainend = 29.928565979004}
ablocks[149] = {type = 6, lane = -1, chainstart = 30.033048629761, seconds = 30.033048629761, chainend = 30.137531280518}
ablocks[150] = {type = 6, lane = -1, chainstart = 30.230405807495, seconds = 30.230405807495, chainend = 30.369714736938}

-- calculation settings
maxdepth = 10 -- how much blocks be analysed to decide collect or skip current block
matchtimeout = 1.5 -- time in seconds which forces grid clean
pbtimeout = 1.25 -- how much seconds we should skip blocks after collecting PB (empirical value)
blockfallingrate = 0.1 -- how quickly blocks fall in the grid, in seconds

currentgamestate = {
	score = 0, -- we start with zero points
	grid = {0, 0, 0}, -- and empty grid
	prevcollectedblockseconds = 0 -- this var holds time when we last time collect block. It uses for detecting math timeouts.
}

function fif(test, if_true, if_false)
	if test then return if_true else return if_false end
end

function greaternumber(a, b)
	return fif(a>b, a, b)
end

-- calculates how much points grid in current state will give to us
-- Examples: 7 | 6 | 7 -> 14000     2 | 0 | 7 -> 1715
function calculateScore(state)
	local points = 0
	local matched = state.grid[1] + state.grid[2] + state.grid[3]
	if matched < 3 then
		return 0
	elseif state.grid[2] == 0 then
		if state.grid[1] > 2 then
			points = state.grid[1] * state.grid[1] * 35
		end
		if state.grid[3] > 2 then
			points = points + state.grid[3] * state.grid[3] * 35
		end
	else
		points = matched * matched * 35
	end
	return points
end

-- returns new grid which obtained from grid in current state after matching
-- Examples: 7 | 6 | 7 -> 0 | 0 | 0      2 | 0 | 7 -> 2 | 0 | 0    0 | 1 | 1 -> 0 | 1 | 1
function calculateGrid(state)
	local resultgrid = {state.grid[1], state.grid[2], state.grid[3]}
	local matched = state.grid[1] + state.grid[2] + state.grid[3]
	if matched < 3 then
		return resultgrid
	elseif state.grid[2] == 0 then
		if state.grid[1] > 2 then
			resultgrid[1] = 0
		end
		if state.grid[3] > 2 then
			resultgrid[3] = 0
		end
		return resultgrid
	else
		return {0, 0, 0}
	end
end

-- returns new game state which obtained from game state 'state' after picking block 'block'
-- Example: state.score = 1000, state.grid = 7 | 7 | 7, block.type = colored, block.lane = -1 (left) -> state.score = 16435, state.grid = 1 | 0 | 0
function pickBlock(state, block)
	local resultstate = {}
	resultstate.grid = {state.grid[1], state.grid[2], state.grid[3]}
	resultstate.score = state.score
	-- 0.25 - time for a hit block to transfer from the track to grid
	local fallingtime = 0.25 + blockfallingrate * (7 - state.grid[block.lane + 2])
	local blocktime = block.chainend - block.seconds
	resultstate.prevcollectedblockseconds = greaternumber(fif(fallingtime > blocktime, block.seconds + fallingtime, block.chainend), state.prevcollectedblockseconds)
	-- check for match timeout
	if block.chainstart - state.prevcollectedblockseconds > matchtimeout then
		resultstate.score = resultstate.score + calculateScore(state)
		resultstate.grid = calculateGrid(state)
	end
	if block.type == 5 then -- spike
		if resultstate.grid[block.lane + 2] > 0 then
			resultstate.grid[block.lane + 2] = resultstate.grid[block.lane + 2] - 1
		end
	elseif block.type == 6 then --colored
		if resultstate.grid[block.lane + 2] == 7 then
			resultstate.score = resultstate.score + calculateScore(resultstate)
			resultstate.grid = calculateGrid(resultstate)
		end
		resultstate.grid[block.lane + 2] = resultstate.grid[block.lane + 2] + 1
	elseif block.type == 101 then -- PB
		local multiplier = fif(block.powerRating == 1, 2, 1.5) -- if this is the big one
		resultstate.score = resultstate.score + math.floor(multiplier * calculateScore(resultstate))
		tempgrid = calculateGrid(resultstate)
		for i = 1, 3 do
			resultstate.grid[i] = resultstate.grid[i] + tempgrid[i]
		end
	end
	return resultstate
end

-- main calculation function
function calculateMaxScore(blocks)
    -- fix bug with short songs
    if maxdepth > #blocks then
        maxdepth = #blocks
    end
	for i = 1, #blocks + 1 - maxdepth do
		-- this var actually useful only at last iteration
		local maxscore = currentgamestate.score
		local maxvalue = currentgamestate.score
		local action = 1 -- what action (skip = 0 or collect = 1) with first block leads to better profit
		-- order of 'open' is actually very important. Last vertices unfolded first.
		-- since we give priority to collect blocks we should analyse this situation first
		local open = {}
		-- if we skips first block
		open[1] = {}
		open[1].score = currentgamestate.score
		open[1].grid = {currentgamestate.grid[1], currentgamestate.grid[2], currentgamestate.grid[3]}
		open[1].action = 0
		open[1].depth = 1
		open[1].prevcollectedblockseconds = currentgamestate.prevcollectedblockseconds
		-- if we collect first block
		open[2] = {}
		open[2].score = currentgamestate.score
		open[2].grid = {currentgamestate.grid[1], currentgamestate.grid[2], currentgamestate.grid[3]}
		open[2].prevcollectedblockseconds = currentgamestate.prevcollectedblockseconds
		open[2] = pickBlock(open[2], blocks[i])
		open[2].action = 1
		open[2].depth = 1
		while #open ~= 0 do
			local current = open[#open]
			if current.depth == maxdepth then
				local localscore = current.score + calculateScore(current)
				local tempgrid = calculateGrid(current)
				local localvalue = localscore + tempgrid[1] + tempgrid[2] + tempgrid[3]
				if localvalue > maxvalue then
					action = current.action
					maxscore = localscore
					maxvalue = localvalue
				end
				open[#open] = nil
			else
				-- again about order in 'open' var
				open[#open + 1] = pickBlock(current, blocks[i + current.depth])
				open[#open].action = current.action
				open[#open].depth = current.depth + 1
				open[#open - 1].depth = open[#open - 1].depth + 1
			end
		end
		if i == #blocks + 1 - maxdepth then -- last iteration
			return maxscore
		else
			if action == 1 then
				print("Block "..i.." - Pick!")
				currentgamestate = pickBlock(currentgamestate, blocks[i])
			else
				print("Block "..i.." - Skip!")
			end
		end
		print(currentgamestate.score.."\n"..currentgamestate.grid[1].." | "..currentgamestate.grid[2].." | "..currentgamestate.grid[3])
	end
end

print("Calculated score: "..calculateMaxScore(ablocks))
